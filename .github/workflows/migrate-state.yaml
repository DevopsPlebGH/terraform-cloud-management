name: Remote State Backend for New TF Organization

on:
  workflow_run:
    workflows: ["Create Terraform Cloud Organization"]
    branches: [main,dev,stage,test]
    types:
      - completed

defaults:
  run:
    working-directory: ./terraform

jobs:
  org_backend:
    name: Create Org Backend
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Download Statefile Artifact
        uses: dawidd6/action-download-artifact@v2
        continue-on-error: true
        with:
          github_token: ${{ github.token }}
          workflow: 33272964
          name: terraformstatefile
          path: ./terraform/
          workflow_conclusion: success
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      - name: Migrate State
        id: migrate
        continue-on-error: true
        run: |
          if [ -f ./terraform.tfstate.enc ]; then
            openssl enc -d -in ./terraform.tfstate.enc -aes-256-cbc -pbkdf2 -pass pass:"${{ secrets.ENCRYPTION_KEY }}" -out ./terraform.tfstate
          else
            echo "Encrypted statefile not found!"
          fi
